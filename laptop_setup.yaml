- name: "Setup local linux machine"
  hosts: localhost
  connection: local
  tasks:
    # apt
    - name: apt - update and upgrade
      become: yes
      apt:
        upgrade: yes
        update_cache: yes
        cache_valid_time: 3600 # caching time: 1 hour
    - name: apt - install utils
      apt:
        name:
          - vim
          - git
          - docker.io
          - docker-compose
          - thunderbird
          - torbrowser-launcher
          - nextcloud-desktop
          - keepassxc
        state: latest

    # firefox
    - name: firefox - install
      apt:
        name:
          - firefox
        state: latest
      tags: firefox
    - name: firefox - get profile folder
      become: no
      shell: cd /home/thor/.mozilla/firefox/*.default-release && pwd # TODO: generalize user
      register: firefox_profile_dir
      tags: firefox
    - name: firefox - configure
      copy:
        src: config/user.js
        dest: "{{ firefox_profile_dir.stdout_lines[0] }}/user.js"
      tags: firefox

    # vscode (snap)
    - name: snap - install snap
      apt:
        name:
          - snapd
        state: latest
    - name: snap - install vscode
      snap:
        name: code
        classic: yes

    # flatpak
    - name: flatpak - install dependencies
      apt:
        name:
          - flatpak
          - gnome-software-plugin-flatpak
        state: latest
      tags:
        - flatpak
    - name: flatpak - add flathub repository
      shell: |
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      tags:
        - flatpak
    - name: flatpak - get installed flatpaks
      shell: flatpak list
      register: flatpak_list
      tags:
        - flatpak
    - name: flatpak - install keepass
      shell: flatpak install -y flathub org.keepassxc.KeePassXC
      when: flatpak_list.stdout.find("org.keepassxc.KeePassXC") == -1
      tags:
        - flatpak
    - name: flatpak - install vlc
      shell: flatpak install -y flathub org.videolan.VLC
      when: flatpak_list.stdout.find("org.videolan.VLC") == -1
      tags:
        - flatpak

    # install signal-desktop
    - name: signal - download signing key
      get_url:
        url: https://updates.signal.org/desktop/apt/keys.asc
        dest: /tmp/keys.asc
        checksum: sha256:2aca20b81a56ba0fbe24bdf58a45023e58a38392d885068afe596785ccd95491
    - name: signal - import signing key
      shell: |
        cat /tmp/keys.asc | gpg --dearmor > /tmp/signal-desktop-keyring.gpg
        cat /tmp/signal-desktop-keyring.gpg | sudo tee -a /usr/share/keyrings/signal-desktop-keyring.gpg > /dev/null
    - name: signal - add repository into sources list
      apt_repository:
        repo: deb [arch=amd64 signed-by=/usr/share/keyrings/signal-desktop-keyring.gpg] https://updates.signal.org/desktop/apt xenial main
        state: present
        update_cache: yes
    - name: signal - install signal-desktop
      apt:
        name: signal-desktop
        state: latest

    # install element-desktop
    - name: element - install dependencies
      apt:
        name:
          - wget
          - apt-transport-https
        state: latest
    - name: element - download signing key
      get_url:
        url: https://packages.element.io/debian/element-io-archive-keyring.gpg
        dest: /usr/share/keyrings/element-io-archive-keyring.gpg
        checksum: sha256:fbf7823608964237024b043b607415b75d7c64221ac98ff5b5e67941f24684c2
    - name: element - add repository into sources list
      apt_repository:
        repo: deb [signed-by=/usr/share/keyrings/element-io-archive-keyring.gpg] https://packages.element.io/debian/ default main
        state: present
        update_cache: yes
    - name: element - install element-desktop
      apt:
        name: element-desktop
        state: latest

    # install VPN
    - name: mullvad - download deb package
      get_url:
        url: https://mullvad.net/download/app/deb/latest
        dest: /tmp/mullvad-latest.deb
        checksum: sha256:0310551f9747a7520181e00c1149beeb180736e0c284db35fa43a29dbb1426ed
      tags:
        - vpn
    - name: mullvad - install with apt
      apt:
        deb: /tmp/mullvad-latest.deb
      tags:
        - vpn
    - name: mullvad - configure
      shell: |
        mullvad auto-connect set on
        mullvad lan set allow
        mullvad dns set default --block-ads --block-gambling --block-malware --block-trackers
      tags:
        - vpn
