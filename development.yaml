- name: "Setup development tools."
  hosts: localhost
  connection: local
  tasks:
    # apt
    - name: apt - update
      apt:
        upgrade: no
        update_cache: yes
        cache_valid_time: 3600 # caching time: 1 hour
      become: yes
    - name: apt - install dev tools
      apt:
        name:
          - git
          - pipx
          - docker.io
          - docker-compose
        state: latest
      become: yes

    # install pyenv (and python build dependencies)
    - name: pyenv - install
      shell: |
        which pyenv || curl https://pyenv.run | bash
        grep -qxF 'eval "$(pyenv init -)"' ~/.bashrc || echo '# pyenv configuration' >> ~/.bashrc
        grep -qxF 'eval "$(pyenv init -)"' ~/.bashrc || echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
        grep -qxF 'eval "$(pyenv init -)"' ~/.bashrc || echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
        grep -qxF 'eval "$(pyenv init -)"' ~/.bashrc || echo 'eval "$(pyenv init -)"' >> ~/.bashrc
    - name: apt - install python build dependencies
      apt:
        name:
          - make
          - build-essential
          - libssl-dev
          - zlib1g-dev
          - libbz2-dev
          - libreadline-dev
          - libsqlite3-dev
          - wget
          - curl
          - llvm
          - libncursesw5-dev
          - xz-utils
          - tk-dev
          - libxml2-dev
          - libxmlsec1-dev
          - libffi-dev
          - liblzma-dev
        state: latest
      become: yes

    # install poetry
    - name: poetry - install
      shell: |
        which poetry || curl -sSL https://install.python-poetry.org | python3 -

    # configure fish shell
    - name: fish - install
      apt:
        name:
          - fish
        state: latest
      become: yes
    - name: fish - create config folder
      file:
        path: ~/.config/fish
        state: directory
    - name: fish - write config file
      copy:
        src: config/config.fish
        dest: ~/.config/fish/config.fish

    # install vscode
    - name: Install wget and gnupg packages
      apt:
        name: [wget, gnupg]
        state: present
    - name: vscode - download Microsoft GPG key
      shell: wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
      args:
        chdir: /tmp
        creates: /tmp/packages.microsoft.gpg
    - name: vscode - Install Microsoft GPG key
      become: yes
      copy:
        src: /tmp/packages.microsoft.gpg
        dest: /etc/apt/keyrings/packages.microsoft.gpg
    - name: vscode - add vscode repository
      become: yes
      shell: |
        echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] \
        https://packages.microsoft.com/repos/code stable main" \
        > /etc/apt/sources.list.d/vscode.list
    - name: vscode - apt install
      become: yes
      apt:
        name:
          - code
        state: latest

    # install vscodium
    - name: vscodium - add the GPG key of the repository
      shell: |
        wget -qO - https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/raw/master/pub.gpg \
        | gpg --dearmor \
        | sudo dd of=/usr/share/keyrings/vscodium-archive-keyring.gpg
    - name: vscodium - add ppa repository
      shell: |
        echo "deb [signed-by=/usr/share/keyrings/vscodium-archive-keyring.gpg arch=amd64] https://download.vscodium.com/debs vscodium main" \
        | sudo tee /etc/apt/sources.list.d/vscodium.list
      become: yes
    - name: vscodium - apt update
      apt:
        upgrade: no
        update_cache: yes
      become: yes
    - name: vscodium - apt install
      apt:
        name:
          - codium
        state: latest
      become: yes
